<?eclipse.ant.import?>

<project basedir="." default="build" name="eLife">
    <description>Builds, tests, and runs the project server.</description>
     <import  file="ant_stubs/util_stubs.xml"/>
       
	<taskdef resource="net/sf/ant4eclipse/antlib.xml" />
	
	<taskdef resource="net/sf/antcontrib/antlib.xml">
  		<classpath>
    		<pathelement location="/Java/ant-contrib/ant-contrib-1.0b3.jar"/>
  		</classpath>
	</taskdef>	
	
	<property name="workspace" value="${basedir}/.." />
	
	<property name="project.name" value="eLife_Server" />
	<property name="dist.jar" value="dist/eLife.jar" />
	<userLibraries userlibraries="./libs.userlibraries" />
	<getEclipseClasspath pathId="eLife.classpath" relative="true" workspace="${workspace}" projectName="${project.name}" />
	<getEclipseClasspath property="eLife.jar_libs" relative="true" workspace="${workspace}" projectName="${project.name}" />
	<available file="dist/lib" type="dir" property="lib_dir.present"/>
	<available file="ext" type="dir" property="ext_dir.present"/>
	<available file="dist/bin" type="dir" property="bin_dir.present"/>
	<getOutputpath property="classes.dir" workspace="${workspace}" projectName="${project.name}" />

	
	<target name="init">
		<delete>
			<fileset dir="dist" includes="**/*" excludes="ext/*" followsymlinks="false" >
				<exclude name="ext/*" />
				<exclude name="*.zip" />
			</fileset>
		</delete>
        <echo message="Emptied previous dist file" />
		
	</target>
	
	<target name="build-lib-dir" depends="" unless="lib_dir.present" >    	
	   	<mkdir dir="dist/lib" />
	</target>	


	
    <target name="compile" depends="init" >
        <javac debug="true" debuglevel="${debuglevel}" destdir="${classes.dir}" >
            <src path="src"/>
        </javac>
        <javac debug="true" debuglevel="${debuglevel}" destdir="${classes.dir}">
            <src path="test"/>
            <classpath refid="eLife.classpath"/>
        </javac>
    </target>
	

	<target name="jar" depends="compile" >
		
		<pathconvert property="flattended.jars" refid="eLife.classpath" pathsep=" ">
		    <chainedmapper>
		        <flattenmapper/>
		        <globmapper from="*" to="../ext/*"/>
		    </chainedmapper>
		</pathconvert>
		<manifest file="MANIFEST.MF" mode="update" >
			<attribute name="Class-Path" value="${flattended.jars}" />
		</manifest>
		<jar destfile="${dist.jar}" 
			update="false"
			basedir="${classes.dir}" 
			includes = "**/*.class" 
			excludes = "**/Test*.class"
			manifest="MANIFEST.MF" />
		<jar destfile="${dist.jar}" 
			update="true"
			basedir="src" 
			includes = "**/*.properties" 
			 />
		<echo>To run this application from the command line without Ant, try:</echo>
		<echo>java -jar "${dist.jar}"</echo>
	</target>

	
	<target name="dist" depends="load-version-number,update_xml,build_dist,increment" />
	<target name="dist-no-inc" depends="load-version-number,update_xml,build_dist" />
	<target name="build" depends="dist-no-inc" />

	<target name="copy-libs" depends="init,build-ext-dir" >
		<pathconvert pathsep="," property="massaged_jar_libs" refid="eLife.classpath" >
			<map from="/Java" to="Java" />
		</pathconvert>
		<echo>List of jar files is ${eLife.jar_libs}</echo>
		<echo>Massaged jar files list is ${massaged_jar_libs}</echo>

		<delete  includeemptydirs="true" quiet="true" >
			<fileset dir="dist/ext" includes="**/*" />
		</delete>
		<delete  includeemptydirs="true" quiet="true" >
			<fileset dir="dist/lib" includes="**/*" />
		</delete>
		<copy todir="dist/ext" flatten="true" >
		   <fileset dir="/" includes="${massaged_jar_libs}"  />
		</copy>
		<copy todir="dist/ext" flatten="true" >
		   <fileset dir="./wrapper" includes="*.jar"  />
		</copy>
		<delete  includeemptydirs="true" quiet="true" >
		    	<fileset dir="dist/ext" >
		    		<include name="junit*" />
		    		<include name="nbunit*" />
		    		<include name="xmlunit*" />
	    		</fileset>
		</delete>
		<copy todir="dist/lib" flatten="true" >
				<fileset dir="." includes="*.dll"  />
			   	<fileset dir="." includes="*.jnilib"  />
		</copy>
	<copy todir="dist/lib" flatten="true" >
			<fileset dir="./wrapper" includes="*.dll"  />
	</copy>	
	</target>
		
    <target name="dist-libs"  depends="copy-libs" >
         <property file="src/au/com/BI/Home/my.properties" />
		<zip destfile="dist/${app_name}-${major_version}${minor_version}-libs.zip" 
			update="false"
			basedir="dist" 
			includes = "ext/*.jar" />
        <!-- copy todir="dist">
	    	<fileset dir="." includes="*.dll" />
	    	<fileset dir="." includes="*.jnilib" />
		</copy -->
	<zip destfile="dist/${app_name}-${major_version}${minor_version}-libs.zip" 
		update="true"
		basedir="dist"
		includes = "lib/*.dll" />
     <zip destfile="dist/${app_name}-${major_version}${minor_version}-libs.zip" 
		update="true"
		basedir="dist"
		includes = "lib/*.jnilib" />
   <zip destfile="dist/${app_name}-${major_version}${minor_version}-libs.zip" 
		update="true"
		basedir="src/au/com/BI"
		includes = "**/*.properties"  />
    </target>
</project>
